<!DOCTYPE html>
<html>

<head>
    <title>Scoreboard Overlay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Russo+One&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Orbitron&display=swap" />
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" /> -->

    <style type="text/tailwindcss">
        @layer components {

            body {
                overflow: hidden
            }
            
            /* Scoreboard Base */
            .scoreboard {
                @apply absolute left-1/2 -translate-x-1/2 w-screen;
                @apply grid grid-cols-[0.8fr_0.4fr_1fr_0.4fr_0.8fr] items-center;
                @apply bg-black/95 shadow-[0_4px_16px_rgba(0,0,0,0.4)];
                top: var(--top-pos);
                height: var(--baseHeight); /* Ensure the scoreboard height is set */
             
                transform: translate(-50%, -100px); /* Start off-screen above */
                opacity: 0; /* Start invisible */
                transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out; /* Smooth slide and fade */
            }

            /* Slide In Top */
            .scoreboard.loaded {
                transform: translate(-50%, 0);
                opacity: 1; 
            }

            /* Sponsor Section */
            .sponsor-section {
                @apply relative h-full flex justify-evenly items-center gap-2.5;
                @apply -ml-3 -mr-px bg-transparent transition-opacity duration-300;
                height: var(--baseHeight);
            }

            .sponsor-section::before {
                content: "";
                @apply absolute inset-0 bg-white border-r-[3px] border-[#0c0c0c] z-0;
                transform: skew(var(--skewAngle));
            }

            .sponsor-section.hidden {
                @apply opacity-0;
            }

            .sponsor-img {
                @apply relative z-10;
                max-height: calc(var(--baseHeight) - 10px);
                max-width: 250px;
            }

            /* Team Info */
            .team-info {
                @apply relative h-full flex items-center justify-between gap-2.5 bg-transparent z-[2];
                height: var(--baseHeight); 
            }

            .team-info::before {
                content: "";
                @apply absolute inset-0 bg-white z-0;
                transform: skew(var(--skewAngle));
            }

            .team-info.team-right::before {
                transform: skew(var(--skewAngleRight));
            }

            .team-logo-container {
                @apply h-full flex justify-center items-center px-[5px] relative z-10;
            }

            .team-logo-img {
                @apply object-contain;
                width: var(--logoSize);
                height: var(--logoSize);
            }

            .team-score {
                @apply px-[18px] flex items-center gap-1 relative z-10;
            }



            /* Score Markers */
            .scoremarker {
                @apply w-[15px] h-[15px] inline-block mx-[3px] rounded-full align-middle;
                @apply bg-[#1111115e] outline outline-2 outline-[#5e5e5e] outline-offset-2;
                @apply transition-all duration-200;
            }

            .scoremarker.active {
                @apply bg-[#ffd700] outline-[#ffd700];
            }


            
            /* Event Title */
            .event-title {
                @apply flex items-center justify-center;
                @apply bg-[rgb(63,63,63)];
                height: var(--baseHeight); 
            }

            .event-title-container {
                @apply text-white uppercase text-xl tracking-[2px];
                @apply flex flex-col items-center justify-center text-center;
                line-height: 1;
            }

            /* .event-title-main {
                @apply m-0 p-0;
            } */

            .event-title-sub {
                @apply text-[0.35em] align-bottom tracking-[3px];
                font-family: Arial, sans-serif;
            }





            /* Maps Section */
            .maps-container {
                @apply flex flex-row items-stretch justify-center gap-0 m-0;
                @apply overflow-hidden relative z-0 -mr-2.5 -ml-[15px];
            }

            .map-item {
                @apply relative flex-1 flex items-center justify-center;
                @apply min-w-0 min-h-0 m-0 p-0 w-full;
                @apply overflow-hidden z-0 border-l-[3px] border-white;
                height: var(--baseHeight); 
            }

            .map-item::before {
                content: "";
                @apply absolute inset-0 z-0 pointer-events-none;
                transform: skew(var(--skewAngleRight));
            }


            .map-item.selected::before {
                @apply border-b-[3px] border-[#ffd700];
                z-index: 15;
            }



            .map-img {
                @apply relative z-10 w-full h-full object-cover block;
            }

            .map-img.isWinner {
                filter: grayscale(50%) blur(2px);
                @apply transition-[filter] duration-[1500ms];
            }

            .map-winner-logo {
                @apply absolute z-20 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 top-[20px];
                @apply w-[25px] h-[25px] object-cover;
            }

            .map-name {
                @apply absolute z-20 left-1/2 bottom-[4px] -translate-x-1/2 ;
                @apply bg-[rgba(58,58,58,0.8)];
                @apply text-white text-xs px-2 ;
                @apply whitespace-nowrap 
                /* @apply whitespace-nowrap shadow-[0_2px_6px_#000]; */
            }
            

            /* .map-name.selected {
                @apply bg-[#ffd700] text-black font-bold;
            } */







            .event-title-img {
                /* @apply hidden; */
                /* @apply  max-h-[var(--baseHeight)] max-w-[200px] object-contain; */

                /* style="height: 0.8em; vertical-align: middle; margin-right: 8px;" */
                width: 270px;
                height: calc(var(--baseHeight) - 10px);
                object-fit: contain;
            }



            /* Control Panel */
            .control-panel {
                @apply fixed bottom-5 right-5 bg-black/80 p-2.5 rounded text-white;
            }

            .control-btn {
                @apply m-1.5 px-2.5 py-1.5 bg-[#08db08] border-none;
                @apply text-white cursor-pointer rounded hover:bg-[#06b006];
            }
        }
    </style>
    <style>
        :root {
            --top-pos: 0px;
            --baseHeight: 58px;
            --logoSize: 50px;
            --scaleOverlay: 1.0;


            --skewAngle: 0deg;
            --skewAngleRight: 0deg;

            --useLogoTitle: true;
        }

        body {
            font-family: 'Russo One', 'Orbitron', sans-serif;
            background-image: url('../GameImages/r6-sample-preview.jpg');
            background-size: cover;
            margin: 0;
        }
    </style>


    <script>
        const fetchData = async () => {
            let fullJson = await fetch(`http://localhost:8080/getFullJson`);
            fullJson = await fullJson.json();

            // assigning main variables
            let INPUTS = fullJson.general
            let COLORS = fullJson.general.color
            let TEAMDATA = fullJson.teams
            let MAPDATA = fullJson.maps

            // setting the base colors
            let color1 = COLORS.BGG_C1.value;
            let color2 = COLORS.BGG_C2.value;
            let color3 = COLORS.BGG_C3.value;
            let color4 = COLORS.BGG_C4.value;

            console.log(fullJson);


            let team1Logo = TEAMDATA.team1.teamLogoUrl;
            let team2Logo = TEAMDATA.team2.teamLogoUrl;

            function updateLogos() {
                const team1LogoElement = document.getElementById('team-1-logo');
                const team2LogoElement = document.getElementById('team-2-logo');

                if (team1Logo) {
                    team1LogoElement.src = team1Logo;
                }

                if (team2Logo) {
                    team2LogoElement.src = team2Logo;
                }
            }
            updateLogos();



            function updateScore(team, teamContainer) {
                const markers = teamContainer.querySelectorAll('.scoremarker');

                // Clear all markers
                markers.forEach(marker => marker.classList.remove('active'));

                // Activate markers based on team score
                for (let i = 0; i < team.teamScore; i++) {
                    markers[i].classList.add('active');
                }
            }

            // Update scores for each team
            const team1Container = document.getElementById('team-1-info');
            const team2Container = document.getElementById('team-2-info');
            updateScore(TEAMDATA.team1, team1Container);
            updateScore(TEAMDATA.team2, team2Container);


            function updateTitles() {
                const eventTitleMain = document.querySelector('.event-title-main');
                const eventTitleSub = document.querySelector('.event-title-sub');

                // Check if root is useLogoTitle
                const rootStyles = getComputedStyle(document.documentElement);
                const useLogoTitle = rootStyles.getPropertyValue('--useLogoTitle').trim(); // Retrieve and trim the value

                const titleImage = document.getElementById('event-title-img');
                const titleText = document.getElementById('event-title-text');

                if (useLogoTitle === 'true') {
                    // If true, set main title to logo image
                    if (INPUTS.file.EVENT_LOGO && INPUTS.file.EVENT_LOGO.value) {
                        // Hide the text and show the image
                        titleText.classList.add('hidden');
                        titleImage.classList.remove('hidden');

                        titleImage.src = INPUTS.file.EVENT_LOGO.value;
                    }
                } else {
                    // Show the text and hide the image
                    titleText.classList.remove('hidden');
                    titleImage.classList.add('hidden');

                    titleText.textContent = INPUTS.text.EVENT_NAME.value;
                }
            }
            updateTitles();






            //             {
            //     "totalMaps": 9,
            //     "selectedMap": {
            //         "map": "",
            //         "selectedMode": "TBA",
            //         "team1Score": 0,
            //         "team2Score": 0,
            //         "modeImage": "http://localhost:8080/files/defaults/default_map.png"
            //     },
            //     "upNext": {
            //         "selectedMap": null,
            //         "mapImage": null,
            //         "mode": "TBA",
            //         "modeImage": "http://localhost:8080/files/defaults/default_map.png",
            //         "team1Score": 0,
            //         "team2Score": 0,
            //         "completed": false,
            //         "hidden": false
            //     },
            //     "mapData": [
            //         {
            //             "selectedMode": "TBA",
            //             "map": "",
            //             "team1Score": 0,
            //             "team2Score": 0,
            //             "completed": false,
            //             "hidden": false,
            //             "modeImage": "http://localhost:8080/files/defaults/default_map.png",
            //             "winner": {
            //                 "teamNumber": "",
            //                 "teamName": "",
            //                 "teamScore": 0,
            //                 "teamLogoUrl": "",
            //                 "teamColor": "#ffffff"
            //             }
            //         },
            //         {
            //             "selectedMode": "TBA",
            //             "map": "",
            //             "team1Score": 0,
            //             "team2Score": 0,
            //             "completed": false,
            //             "hidden": false,
            //             "modeImage": "http://localhost:8080/files/defaults/default_map.png",
            //             "winner": {
            //                 "teamNumber": "",
            //                 "teamName": "",
            //                 "teamScore": 0,
            //                 "teamLogoUrl": "",
            //                 "teamColor": "#ffffff"
            //             }
            //         },
            //         {
            //             "selectedMode": "TBA",
            //             "map": "",
            //             "team1Score": 0,
            //             "team2Score": 0,
            //             "completed": false,
            //             "hidden": false,
            //             "modeImage": "http://localhost:8080/files/defaults/default_map.png",
            //             "winner": {
            //                 "teamNumber": "",
            //                 "teamName": "",
            //                 "teamScore": 0,
            //                 "teamLogoUrl": "",
            //                 "teamColor": "#ffffff"
            //             }
            //         },
            //         {
            //             "selectedMode": "TBA",
            //             "map": "",
            //             "team1Score": 0,
            //             "team2Score": 0,
            //             "completed": false,
            //             "hidden": false,
            //             "modeImage": "http://localhost:8080/files/defaults/default_map.png",
            //             "winner": {
            //                 "teamNumber": "",
            //                 "teamName": "",
            //                 "teamScore": 0,
            //                 "teamLogoUrl": "",
            //                 "teamColor": "#ffffff"
            //             }
            //         },
            //         {
            //             "selectedMode": "TBA",
            //             "map": "",
            //             "team1Score": 0,
            //             "team2Score": 0,
            //             "completed": false,
            //             "hidden": false,
            //             "modeImage": "http://localhost:8080/files/defaults/default_map.png",
            //             "winner": {
            //                 "teamNumber": "",
            //                 "teamName": "",
            //                 "teamScore": 0,
            //                 "teamLogoUrl": "",
            //                 "teamColor": "#ffffff"
            //             }
            //         },
            //         {
            //             "selectedMode": "TBA",
            //             "map": "",
            //             "team1Score": 0,
            //             "team2Score": 0,
            //             "completed": false,
            //             "hidden": false,
            //             "modeImage": "http://localhost:8080/files/defaults/default_map.png",
            //             "winner": {
            //                 "teamNumber": "",
            //                 "teamName": "",
            //                 "teamScore": 0,
            //                 "teamLogoUrl": "",
            //                 "teamColor": "#ffffff"
            //             }
            //         },
            //         {
            //             "selectedMode": "TBA",
            //             "map": "",
            //             "team1Score": 0,
            //             "team2Score": 0,
            //             "completed": false,
            //             "hidden": false,
            //             "modeImage": "http://localhost:8080/files/defaults/default_map.png",
            //             "winner": {
            //                 "teamNumber": "",
            //                 "teamName": "",
            //                 "teamScore": 0,
            //                 "teamLogoUrl": "",
            //                 "teamColor": "#ffffff"
            //             }
            //         },
            //         {
            //             "selectedMode": "TBA",
            //             "map": "",
            //             "team1Score": 0,
            //             "team2Score": 0,
            //             "completed": false,
            //             "hidden": false,
            //             "modeImage": "http://localhost:8080/files/defaults/default_map.png",
            //             "winner": {
            //                 "teamNumber": "",
            //                 "teamName": "",
            //                 "teamScore": 0,
            //                 "teamLogoUrl": "",
            //                 "teamColor": "#ffffff"
            //             }
            //         },
            //         {
            //             "selectedMode": "TBA",
            //             "map": "",
            //             "team1Score": 0,
            //             "team2Score": 0,
            //             "completed": false,
            //             "hidden": false,
            //             "modeImage": "http://localhost:8080/files/defaults/default_map.png",
            //             "winner": {
            //                 "teamNumber": "",
            //                 "teamName": "",
            //                 "teamScore": 0,
            //                 "teamLogoUrl": "",
            //                 "teamColor": "#ffffff"
            //             }
            //         }
            //     ]
            // }





            function updateMaps() {
                const mapsContainer = document.querySelector('.maps-container');


                // loop thru each map-item and set if selected, and set map-name class
                const mapDataArray = MAPDATA.mapData;
                console.log(mapDataArray);
                mapDataArray.forEach((map, index) => {

                    const mapItem = mapsContainer.querySelectorAll('.map-item')[index];
                    const mapImageElement = mapItem.querySelector('.map-img');


                    // Hide 'hidden/missing' maps
                    // - should mayb use map.hidden as a flag but we hide it before sending it over which is maybe not a good thing??
                    if (index < MAPDATA.totalMaps) {
                        mapItem.classList.remove('hidden');
                    } else {
                        mapItem.classList.add('hidden');
                    }


                    // Set Map Image
                    if (map.mapImage) {
                        mapImageElement.src = map.mapImage;
                    }


                    // Check & Set Map Winner
                    if (map.completed && map.winner && map.winner.teamLogoUrl) {
                        const winnerLogoElement = mapItem.querySelector('.map-winner-logo');
                        winnerLogoElement.src = map.winner.teamLogoUrl;
                        winnerLogoElement.classList.remove('hidden');
                        mapImageElement.classList.add('isWinner');
                    } else {
                        const winnerLogoElement = mapItem.querySelector('.map-winner-logo');
                        winnerLogoElement.classList.add('hidden');
                        mapImageElement.classList.remove('isWinner');
                    }


                    console.log("Selected Map:", MAPDATA.selectedMap.map, "Current Map:", map.selectedMap);

                    // if (MAPDATA.selectedMap && map.selectedMap === MAPDATA.selectedMap.map) {
                    //     console.log("It's a match!");
                    //     mapItem.classList.add('selected');
                    // } else {
                    //     mapItem.classList.remove('selected');
                    // }
                });
            }
            updateMaps();




            function updateSponsors() {
                // update 'sponsors' section
                const sponsor1 = document.getElementById('sponsor-1');
                const sponsor2 = document.getElementById('sponsor-2');

                const sponsorObj = {
                    sponsor1: INPUTS.file.SPONSOR_1.value ? INPUTS.file.SPONSOR_1.value : INPUTS.file.BGG_L1.value,
                    sponsor2: INPUTS.file.SPONSOR_2.value ? INPUTS.file.SPONSOR_2.value : INPUTS.file.BGG_L2.value,
                }
                if (sponsorObj.sponsor1) {
                    sponsor1.src = sponsorObj.sponsor1;
                }
                if (sponsorObj.sponsor2) {
                    sponsor2.src = sponsorObj.sponsor2;
                }
            }
            updateSponsors();



        }

        document.addEventListener('DOMContentLoaded', async () => {
            // 
            await fetchData()

            // show scoreboard only when everything is loaded

            document.querySelector('#scoreboard').classList.add('loaded');
            document.body.classList.add('loaded');
        });



        // Polling every 3 seconds
        setInterval(() => {
            fetchData()
        }, 3000);
    </script>
</head>

<body>
    <div id="scoreboard" class="scoreboard">

        <!-- Sponsor Section -->
        <div id="sponsor-section" class="sponsor-section">
            <img id='sponsor-1' class="sponsor-img" src="EsportsDashx1000.png" alt="Sponsor 1" />
            <img id='sponsor-2' class="sponsor-img"
                src="https://broadcast.gg/wp-content/uploads/2019/04/BGG-2.0-Header-MaxArtboard-1-1.png"
                alt="Sponsor 2" />
        </div>

        <!-- Team Left Section -->
        <div id="team-1-info" class="team-info">
            <div class="team-logo-container">
                <img id="team-1-logo" class="team-logo-img" src="https://esportsdash.com/icon.png" alt="Team 1 Logo" />
            </div>

            <div class="team-score">
                <div class="scoremarker active"></div>
                <div class="scoremarker"></div>
                <div class="scoremarker"></div>
                <div class="scoremarker"></div>
                <div class="scoremarker"></div>
            </div>
        </div>

        <!-- Event Title Section -->
        <div class="event-title">
            <div class="event-title-container">
                <div id="event-title-main" class="event-title-main">
                    <img id='event-title-img' class="event-title-img hidden" src="https://esportsdash.com/icon.png"
                        alt="Event Logo" />
                    <p id="event-title-text">Summer Bash - Finals</p>
                </div>
                <p id="event-title-sub" class="event-title-sub">Powered by EsportsDash</p>
            </div>
        </div>

        <!-- Team Right Section -->
        <div id="team-2-info" class="team-info team-right">
            <div class="team-score">
                <div class="scoremarker active"></div>
                <div class="scoremarker"></div>
                <div class="scoremarker"></div>
                <div class="scoremarker"></div>
                <div class="scoremarker"></div>
            </div>
            <div class="team-logo-container">
                <img id="team-2-logo" class="team-logo-img" src="https://esportsdash.com/icon.png" alt="Team 2 Logo" />
            </div>
        </div>

        <!-- Maps section -->
        <div class="maps-container">
            <div class="map-item ">
                <img class="map-img " src="https://static.wikia.nocookie.net/rainbowsix/images/7/79/Bartlett_U.png"
                    alt="Map 1" />
                <img class="map-winner-logo" src="https://esportsdash.com/icon.png" alt="Winner Logo" />
                <div class="map-name">Map 1</div>
            </div>

            <div class="map-item selected">
                <img class="map-img" src="https://static.wikia.nocookie.net/rainbowsix/images/7/79/Bartlett_U.png"
                    alt="Map 2" />
                <img class="map-winner-logo hidden" src="https://placehold.co/40x40" alt="Winner Logo" />
                <div class="map-name">Map 2</div>
            </div>

            <div class="map-item">
                <img class="map-img" src="" alt="Map 3" />
                <img class="map-winner-logo hidden" src="https://placehold.co/40x40" alt="Winner Logo" />
                <div class="map-name">Map 3</div>
            </div>

            <div class="map-item">
                <img class="map-img" src="" alt="Map 4" />
                <img class="map-winner-logo hidden" src="https://placehold.co/40x40" alt="Winner Logo" />
                <div class="map-name">Map 4</div>
            </div>

            <div class="map-item">
                <img class="map-img" src="" alt="Map 5" />
                <img class="map-winner-logo hidden" src="https://placehold.co/40x40" alt="Winner Logo" />
                <div class="map-name">Map 5</div>
            </div>
        </div>
    </div>

    <!-- Control panel for toggling sections -->
    <div id="control-panel" class="control-panel">
        <button onclick="toggleSponsor()" class="control-btn">Toggle Sponsor</button>
        <button onclick="toggleEventDesc()" class="control-btn">Toggle Event Description</button>

        <button onclick="useLogoTitle()" class="control-btn">Use Logo Title</button>
    </div>

    <script>
        function toggleSponsor() {
            const sponsorSection = document.getElementById('sponsor-section');
            sponsorSection.classList.toggle('hidden');
        }

        function toggleEventDesc() {
            const eventDescSection = document.getElementById('event-desc-section');
            if (eventDescSection) {
                eventDescSection.classList.toggle('hidden');
            }
        }

        function useLogoTitle() {
            const rootStyles = getComputedStyle(document.documentElement);
            const useLogoTitle = rootStyles.getPropertyValue('--useLogoTitle').trim();

            if (useLogoTitle === 'true') {
                document.documentElement.style.setProperty('--useLogoTitle', 'false');
            } else {
                document.documentElement.style.setProperty('--useLogoTitle', 'true');
            }

            // Re-fetch data to update titles
            fetchData();
        }
    </script>
</body>

</html>